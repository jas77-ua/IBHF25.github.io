<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>SabaDingo - Quiz Financiero</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    /* === ESTILOS ESPEC√çFICOS SABADINGO === */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

    body {
      font-family: "Poppins", sans-serif;
      display: flex;
      flex-direction: column;
      width: 100vw;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow-x: hidden;
      overflow-y: auto;
      min-height: 100vh;
    }

    /* Top bar (energ√≠a y monedas) */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-bottom: none;
      font-size: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar button {
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 10px;
    }

    .top-bar button:hover {
      background: rgba(66, 217, 255, 0.1) !important;
      transform: scale(1.1);
    }

    .energy {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: #ef4444;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.3s ease;
      font-size: 1.3rem;
    }

    .energy:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3);
    }

    .heart {
      display: inline-block;
      transition: all 0.3s ease;
    }

    .heart.lost {
      opacity: 0.3;
      filter: grayscale(100%);
    }

    @keyframes heartLoss {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); filter: brightness(1.5); }
      100% { transform: scale(0.8); opacity: 0.3; filter: grayscale(100%); }
    }

    .heart.losing {
      animation: heartLoss 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .coins {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: white;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(255, 179, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.3s ease;
    }

    .coins:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 179, 0, 0.4);
    }

    /* Logo/T√≠tulo principal */
    .main-logo {
      text-align: center;
      padding: 40px 20px 20px;
      margin: 0 auto;
      max-width: 720px;
    }

    .main-logo h1 {
      font-size: 4rem;
      font-weight: 900;
      margin: 0;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 30%, #FF6B6B 60%, #667eea 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
      letter-spacing: -2px;
      animation: logoFloat 3s ease-in-out infinite;
      position: relative;
      display: inline-block;
    }

    .main-logo h1::before {
      content: 'ü¶â';
      position: absolute;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 3rem;
      animation: owlBounce 2s ease-in-out infinite;
    }

    .main-logo h1::after {
      content: 'üìö';
      position: absolute;
      right: -60px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2.5rem;
      animation: bookSpin 4s linear infinite;
    }

    @keyframes logoFloat {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes owlBounce {
      0%, 100% {
        transform: translateY(-50%) rotate(0deg);
      }
      50% {
        transform: translateY(-60%) rotate(-10deg);
      }
    }

    @keyframes bookSpin {
      0% {
        transform: translateY(-50%) rotate(0deg);
      }
      100% {
        transform: translateY(-50%) rotate(360deg);
      }
    }

    .main-logo .subtitle {
      font-size: 1.2rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 10px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    .main-logo .subtitle::before {
      content: '‚ú® ';
    }

    .main-logo .subtitle::after {
      content: ' ‚ú®';
    }

    /* Decorative line */
    .decorative-line {
      width: 200px;
      height: 4px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
      margin: 20px auto;
      border-radius: 2px;
      animation: lineGlow 2s ease-in-out infinite;
    }

    @keyframes lineGlow {
      0%, 100% {
        opacity: 0.5;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      }
      50% {
        opacity: 1;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
      }
    }

    /* Mapa de niveles */
    .level-map {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding: 20px 0 100px;
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      background: transparent;
      box-sizing: border-box;
    }

    .level {
      position: relative;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin: 38px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 700;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #764ba2;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15),
                  0 0 0 4px rgba(255, 255, 255, 0.3);
      border: 3px solid rgba(255, 255, 255, 0.8);
    }

    /* Row wrapper to control spacing between levels */
    .row {
      position: relative;
      width: 100%;
      height: 140px;
      display: flex;
      align-items: center;
      box-sizing: border-box;
    }

    /* Posicionamiento expl√≠cito a izquierda/derecha dentro de la fila */
    .row .level.left {
      left: 18%;
      transform: translateX(-50%);
    }
    .row .level.right {
      left: 82%;
      transform: translateX(-50%);
    }

    /* Ajuste: asegurar que left/right se posicionan relativamente dentro de la row */
    .row .level {
      position: absolute;
    }

    /* ocultar pseudo-conectores ahora que usaremos SVG */
    .level::after {
      display: none;
    }

    .level.completed {
      background: linear-gradient(135deg, #42d9ff 0%, #0066cc 100%);
      color: white;
      box-shadow: 0 10px 30px rgba(66, 217, 255, 0.4),
                  0 0 0 4px rgba(255, 255, 255, 0.5);
      animation: completedPulse 2s ease-in-out infinite;
    }

    @keyframes completedPulse {
      0%, 100% {
        box-shadow: 0 10px 30px rgba(66, 217, 255, 0.4),
                    0 0 0 4px rgba(255, 255, 255, 0.5);
      }
      50% {
        box-shadow: 0 10px 30px rgba(66, 217, 255, 0.6),
                    0 0 0 6px rgba(255, 255, 255, 0.7);
      }
    }

    .level.locked {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: #6b7280;
      cursor: not-allowed;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1),
                  0 0 0 4px rgba(255, 255, 255, 0.3);
      opacity: 0.6;
    }

    .level:not(.locked):hover {
      transform: scale(1.15) translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25),
                  0 0 0 6px rgba(255, 255, 255, 0.6);
    }

    .level:not(.locked):active {
      transform: scale(1.05) translateY(-2px);
    }

    /* Zig-zag irregular estilo Duolingo: alterna offset lateral y a√±ade conectores */
  /* (Se usan clases .left / .right por fila; se elimina el uso de nth-child que causaba conflicto) */

    /* Conectores diagonales: usando pseudo-elementos en cada level que conecta con el siguiente */
    .level::after {
      content: '';
      position: absolute;
      width: 3px;
      height: 110px; /* conector ajustado para alcanzar la l√≠nea central */
      background: linear-gradient(to bottom, #e0f7ff, transparent);
      left: 50%;
      top: 100%;
      transform-origin: top center;
      z-index: -1;
      border-radius: 2px;
    }

    /* Usar clases left/right para rotar conectores hacia la l√≠nea central */
    .row .level.left::after {
      transform: translateX(-50%) rotate(32deg);
    }
    .row .level.right::after {
      transform: translateX(-50%) rotate(-32deg);
    }

    /* Ocultar conector en el √∫ltimo nodo */
    .level:last-child::after { display: none; }

    /* Burbuja de nivel */
    .level-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 35px 30px;
      border-radius: 25px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      text-align: center;
      width: 320px;
      border: 2px solid rgba(255, 255, 255, 0.8);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .level-popup.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .level-popup h2 {
      margin-bottom: 20px;
      font-size: 1.4rem;
      font-weight: 700;
      color: #764ba2;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .level-popup button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 15px;
      padding: 14px 32px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.05rem;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .level-popup button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5);
    }

    .level-popup button:active {
      transform: translateY(-1px);
    }

    .close-popup {
      position: absolute;
      top: 15px;
      right: 15px;
      cursor: pointer;
      font-size: 1.5rem;
      font-weight: bold;
      color: #9ca3af;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .close-popup:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      transform: rotate(90deg);
    }

    .connector {
      position: absolute;
      top: 0;
      left: 50%;
      width: 8px;
      height: 100%;
      background: linear-gradient(180deg,
                                  rgba(255, 255, 255, 0.4) 0%,
                                  rgba(255, 255, 255, 0.2) 50%,
                                  transparent 100%);
      z-index: -2;
      transform: translateX(-50%);
      border-radius: 4px;
    }

    /* Mobile connector adjustments */
    @media (max-width: 640px) {
      .connector {
        left: 50%;
        width: 6px;
        background: linear-gradient(180deg,
                                    rgba(255, 255, 255, 0.3) 0%,
                                    rgba(255, 255, 255, 0.15) 50%,
                                    transparent 100%);
      }
    }


    

    /* Pantalla del nivel (demo) */
    .level-demo {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .progress-bar {
      width: 100%;
      height: 14px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg,
                                  transparent,
                                  rgba(255, 255, 255, 0.3),
                                  transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Estilos para quiz */
    .quiz-option {
      background: white;
      border: 3px solid transparent;
      border-radius: 16px;
      padding: 18px 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 1.05rem;
      text-align: left;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
      color: #1f2937;
    }

    .quiz-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg,
                                  transparent,
                                  rgba(102, 126, 234, 0.1),
                                  transparent);
      transition: left 0.5s;
    }

    .quiz-option:hover:not(:disabled)::before {
      left: 100%;
    }

    .quiz-option:hover:not(:disabled) {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-color: #667eea;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.25);
    }

    .quiz-option:active:not(:disabled) {
      transform: translateY(-1px) scale(1);
    }

    .quiz-option.correct {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
      animation: correctPulse 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .quiz-option.correct::after {
      content: '‚úì';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      color: #10b981;
      font-weight: bold;
    }

    .quiz-option.incorrect {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-color: #ef4444;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
    }

    .quiz-option.incorrect::after {
      content: '‚úó';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5rem;
      color: #ef4444;
      font-weight: bold;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.05); }
      50% { transform: scale(0.98); }
      75% { transform: scale(1.02); }
    }

    .quiz-option:disabled {
      cursor: not-allowed;
    }

    /* Pantalla de Game Over */
    .game-over-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .game-over-screen h1 {
      font-size: 3rem;
      margin-bottom: 20px;
      font-weight: 800;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      animation: bounceIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .game-over-screen p {
      font-size: 1.3rem;
      margin: 20px 0;
      opacity: 0.95;
      max-width: 500px;
      line-height: 1.6;
    }

    .game-over-screen button {
      background: white;
      color: #ef4444;
      border: none;
      border-radius: 20px;
      padding: 18px 50px;
      font-size: 1.3rem;
      font-weight: 800;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .game-over-screen button:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }

    .broken-heart {
      font-size: 5rem;
      margin: 20px 0;
      animation: heartBreak 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes heartBreak {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(-10deg); }
      50% { transform: scale(0.8) rotate(10deg); }
      75% { transform: scale(1.1) rotate(-5deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    /* Pantalla de resultados */
    .results-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .results-screen::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 50% 50%,
                                  rgba(255, 255, 255, 0.1) 0%,
                                  transparent 70%);
      animation: pulseGlow 3s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .results-screen h1 {
      font-size: 3rem;
      margin-bottom: 20px;
      animation: bounceIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 800;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1;
    }

    .results-screen .score {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 30px 50px;
      margin: 30px 0;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      position: relative;
      z-index: 1;
    }

    .results-screen .score > div:first-child {
      font-size: 4rem;
      font-weight: 800;
      animation: scoreCount 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    @keyframes scoreCount {
      from {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .results-screen .rewards {
      display: flex;
      gap: 20px;
      margin: 40px 0;
      font-size: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .results-screen .rewards > div {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      border-radius: 20px;
      font-weight: 700;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      animation-fill-mode: both;
    }

    .results-screen .rewards > div:nth-child(1) {
      animation-delay: 0.2s;
    }

    .results-screen .rewards > div:nth-child(2) {
      animation-delay: 0.3s;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .results-screen button {
      background: white;
      color: #764ba2;
      border: none;
      border-radius: 20px;
      padding: 18px 50px;
      font-size: 1.3rem;
      font-weight: 800;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      z-index: 1;
    }

    .results-screen button:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }

    .results-screen button:active {
      transform: translateY(-2px) scale(1.02);
    }

    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .quiz-feedback {
      padding: 18px 24px;
      border-radius: 16px;
      margin-top: 25px;
      font-weight: 700;
      font-size: 1.05rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border: 2px solid transparent;
    }

    .quiz-feedback.correct {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border-color: #10b981;
    }

    .quiz-feedback.incorrect {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border-color: #ef4444;
    }

    .shake {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .celebrate {
      animation: celebrate 0.6s;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1) rotate(5deg); }
    }

    /* Streak counter */
    .streak-badge {
      position: fixed;
      top: 15px;
      right: 15px;
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      color: white;
      padding: 10px 18px;
      border-radius: 25px;
      font-weight: 800;
      font-size: 0.95rem;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
      display: none;
      z-index: 999;
      border: 3px solid rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      cursor: help;
      transition: all 0.3s ease;
    }

    .streak-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 28px rgba(239, 68, 68, 0.5);
    }

    .streak-badge.show {
      display: block;
      animation: streakBounce 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .streak-badge.celebrate-streak {
      animation: celebrateStreakAnimation 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes streakBounce {
      0% {
        transform: translateX(80px) scale(0);
        opacity: 0;
      }
      50% {
        transform: translateX(-10px) scale(1.1);
      }
      100% {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }

    @keyframes celebrateStreakAnimation {
      0%, 100% {
        transform: scale(1);
      }
      25% {
        transform: scale(1.15) rotate(-5deg);
      }
      75% {
        transform: scale(1.15) rotate(5deg);
      }
    }

    /* Notificaci√≥n de racha */
    .streak-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      color: white;
      padding: 30px 50px;
      border-radius: 25px;
      font-weight: 800;
      font-size: 1.8rem;
      box-shadow: 0 20px 60px rgba(239, 68, 68, 0.6);
      z-index: 9999;
      border: 4px solid rgba(255, 255, 255, 0.6);
      text-align: center;
      opacity: 0;
      pointer-events: none;
    }

    .streak-notification.show {
      animation: streakNotificationShow 2.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes streakNotificationShow {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      15% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 1;
      }
      25% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      85% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
      }
    }

    /* Confetti effect */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #42d9ff;
      position: absolute;
      animation: confettiFall 3s linear forwards;
    }

    @keyframes confettiFall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Backdrop overlay for popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .popup-overlay.show {
      opacity: 1;
    }

    /* Enhanced SVG connectors */
    .map-svg path {
      filter: drop-shadow(0 4px 8px rgba(255, 255, 255, 0.2));
    }

    /* === REWARDS MODAL === */
    .rewards-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      display: none;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }

    .rewards-modal.show {
      opacity: 1;
    }

    .rewards-modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 30px;
      padding: 40px 35px;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
      border: 3px solid rgba(255, 255, 255, 0.9);
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .rewards-modal.show .rewards-modal-content {
      transform: scale(1);
    }

    .close-rewards {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 1.8rem;
      font-weight: bold;
      color: #9ca3af;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .close-rewards:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      transform: rotate(90deg);
    }

    .rewards-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin: 0 0 10px 0;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 30%, #FF6B6B 60%, #667eea 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      animation: titleShine 3s ease-in-out infinite;
    }

    @keyframes titleShine {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    .rewards-subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 1.1rem;
      margin: 0 0 25px 0;
      font-weight: 600;
    }

    .rewards-balance {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 25px;
      border-radius: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      animation: balancePulse 2s ease-in-out infinite;
    }

    @keyframes balancePulse {
      0%, 100% { box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }
      50% { box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6); }
    }

    .balance-label {
      font-size: 1.1rem;
      font-weight: 600;
      opacity: 0.95;
    }

    .balance-amount {
      font-size: 1.4rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rewards-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      border-bottom: 3px solid #e5e7eb;
      padding-bottom: 0;
    }

    .rewards-tab {
      flex: 1;
      padding: 14px 20px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-weight: 700;
      font-size: 1.05rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -3px;
      transition: all 0.3s ease;
      border-radius: 8px 8px 0 0;
    }

    .rewards-tab:hover {
      background: rgba(102, 126, 234, 0.05);
      color: #667eea;
    }

    .rewards-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .rewards-container {
      margin-bottom: 30px;
      min-height: 400px;
    }

    .rewards-section {
      display: none;
    }

    .rewards-section.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }

    .reward-card {
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      border: 2px solid #e5e7eb;
      border-radius: 18px;
      padding: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .reward-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      transition: left 0.5s;
    }

    .reward-card:hover::before {
      left: 100%;
    }

    .reward-card:hover {
      transform: translateY(-5px);
      border-color: #667eea;
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.25);
    }

    .reward-card.purchased {
      opacity: 0.6;
      border-color: #10b981;
      background: linear-gradient(135deg, #d1fae5 0%, #f0fdf4 100%);
    }

    .reward-card.purchased::after {
      content: '‚úì CANJEADO';
      position: absolute;
      top: 12px;
      right: 12px;
      background: #10b981;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .reward-card.insufficient {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .reward-icon {
      font-size: 3rem;
      text-align: center;
      margin-bottom: 12px;
    }

    .reward-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
      text-align: center;
      line-height: 1.3;
    }

    .reward-description {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 12px;
      text-align: center;
      line-height: 1.4;
    }

    .reward-price {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: white;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 1.05rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(255, 179, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .reward-card.insufficient .reward-price {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      box-shadow: 0 4px 12px rgba(156, 163, 175, 0.2);
    }

    .my-prizes-section {
      background: rgba(102, 126, 234, 0.05);
      padding: 20px;
      border-radius: 18px;
      margin-top: 25px;
      border: 2px dashed #667eea;
    }

    .my-prizes-section h3 {
      margin: 0 0 15px 0;
      color: #667eea;
      font-size: 1.3rem;
      font-weight: 800;
      text-align: center;
    }

    .my-prizes-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    .no-prizes {
      color: #9ca3af;
      font-style: italic;
      text-align: center;
      margin: 10px 0;
    }

    .prize-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 10px 18px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: prizeAppear 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes prizeAppear {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Make coins clickable */
    .coins {
      cursor: pointer;
      user-select: none;
    }

    /* Responsive adjustments - Tablet */
    @media (max-width: 768px) {
      .main-logo {
        padding: 30px 15px 15px;
      }

      .main-logo h1 {
        font-size: 3.5rem;
      }

      .main-logo h1::before {
        left: -50px;
        font-size: 2.5rem;
      }

      .main-logo h1::after {
        right: -50px;
        font-size: 2.2rem;
      }

      .level-map {
        padding: 15px 0 80px;
      }

      .row {
        height: 120px;
      }

      .level {
        width: 80px;
        height: 80px;
        font-size: 1.4rem;
      }
    }

    /* Responsive adjustments - Large Mobile */
    @media (max-width: 640px) {
      .main-logo {
        padding: 25px 15px 10px;
      }

      .main-logo h1 {
        font-size: 3rem;
        letter-spacing: -1.5px;
      }

      .main-logo h1::before {
        left: -45px;
        font-size: 2.2rem;
      }

      .main-logo h1::after {
        right: -45px;
        font-size: 2rem;
      }

      .main-logo .subtitle {
        font-size: 1rem;
        letter-spacing: 1.5px;
      }

      .decorative-line {
        width: 180px;
        margin: 15px auto;
      }

      .level-map {
        padding: 10px 0 60px;
      }

      .row {
        height: 110px;
      }

      .row .level.left {
        left: 20%;
      }

      .row .level.right {
        left: 80%;
      }

      .level-popup {
        width: 90%;
        max-width: 320px;
        padding: 30px 25px;
      }

      .level-popup h2 {
        font-size: 1.2rem;
      }

      .level-popup button {
        padding: 12px 28px;
        font-size: 1rem;
      }

      /* Hide streak on map view */
      #map:not([style*="display: none"]) ~ .streak-badge {
        display: none !important;
      }
    }

    /* Responsive - Rewards Modal */
    @media (max-width: 768px) {
      .rewards-modal-content {
        padding: 30px 25px;
        margin: 10px;
      }

      .rewards-title {
        font-size: 2rem;
      }

      .rewards-subtitle {
        font-size: 1rem;
      }

      .rewards-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .rewards-modal {
        padding: 10px;
      }

      .rewards-modal-content {
        padding: 25px 20px;
        border-radius: 20px;
      }

      .rewards-title {
        font-size: 1.8rem;
      }

      .rewards-subtitle {
        font-size: 0.9rem;
      }

      .rewards-balance {
        flex-direction: column;
        gap: 8px;
        padding: 15px 20px;
      }

      .balance-label {
        font-size: 1rem;
      }

      .balance-amount {
        font-size: 1.2rem;
      }

      .rewards-tab {
        padding: 12px 16px;
        font-size: 0.95rem;
      }

      .reward-card {
        padding: 18px;
      }

      .reward-icon {
        font-size: 2.5rem;
      }

      .reward-name {
        font-size: 1rem;
      }

      .reward-description {
        font-size: 0.85rem;
      }

      .my-prizes-section {
        padding: 15px;
      }

      .my-prizes-section h3 {
        font-size: 1.1rem;
      }

      .prize-badge {
        font-size: 0.85rem;
        padding: 8px 14px;
      }
    }

    /* Responsive adjustments - Mobile */
    @media (max-width: 480px) {
      .main-logo {
        padding: 20px 10px 10px;
      }

      .main-logo h1 {
        font-size: 2.2rem;
        letter-spacing: -1px;
      }

      .main-logo h1::before {
        left: -35px;
        font-size: 1.8rem;
      }

      .main-logo h1::after {
        right: -35px;
        font-size: 1.6rem;
      }

      .main-logo .subtitle {
        font-size: 0.85rem;
        letter-spacing: 1px;
      }

      .decorative-line {
        width: 140px;
        height: 3px;
      }

      .level-map {
        padding: 5px 0 50px;
      }

      .row {
        height: 100px;
      }

      .level {
        width: 70px;
        height: 70px;
        font-size: 1.2rem;
        margin: 30px 0;
      }

      .row .level.left {
        left: 22%;
      }

      .row .level.right {
        left: 78%;
      }

      .quiz-option {
        font-size: 0.95rem;
        padding: 14px 16px;
      }

      #quiz-question {
        font-size: 1.05rem !important;
      }

      .results-screen h1 {
        font-size: 2rem;
      }

      .results-screen .score > div:first-child {
        font-size: 3rem;
      }

      .results-screen .rewards {
        font-size: 1.2rem;
        gap: 15px;
      }

      .results-screen .rewards > div {
        padding: 12px 20px;
      }

      #quiz-container {
        padding: 25px 20px !important;
        width: 95% !important;
      }

      .level-popup {
        width: 92%;
        max-width: 300px;
        padding: 25px 20px;
      }

      .level-popup h2 {
        font-size: 1.1rem;
      }

      .level-popup button {
        padding: 12px 24px;
        font-size: 0.95rem;
      }

      .top-bar {
        padding: 10px 12px;
      }

      .top-bar button {
        padding: 6px 10px;
        font-size: 1.3rem;
      }

      .energy, .coins {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      .heart {
        font-size: 1.1rem;
      }

      .streak-badge {
        top: 175px;
        right: 10px;
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      .top-bar {
        flex-wrap: wrap;
      }

      /* Hide streak badge in map, show only during quiz */
      #map:not([style*="display: none"]) ~ .streak-badge {
        display: none !important;
      }

      .game-over-screen h1 {
        font-size: 2.2rem;
      }

      .game-over-screen p {
        font-size: 1.1rem;
        padding: 0 15px;
      }

      .game-over-screen button {
        padding: 14px 35px;
        font-size: 1.1rem;
      }

      .broken-heart {
        font-size: 4rem;
      }

      .streak-notification {
        padding: 25px 35px;
        font-size: 1.5rem;
        width: 85%;
        max-width: 320px;
      }
    }

    /* Responsive adjustments - Small Mobile */
    @media (max-width: 375px) {
      .main-logo h1 {
        font-size: 1.8rem;
      }

      .main-logo h1::before {
        left: -30px;
        font-size: 1.5rem;
      }

      .main-logo h1::after {
        right: -30px;
        font-size: 1.3rem;
      }

      .main-logo .subtitle {
        font-size: 0.75rem;
      }

      .decorative-line {
        width: 120px;
      }

      .level {
        width: 65px;
        height: 65px;
        font-size: 1.1rem;
        margin: 25px 0;
      }

      .row {
        height: 90px;
      }

      #quiz-container {
        padding: 20px 15px !important;
      }

      .quiz-option {
        padding: 12px 14px;
        font-size: 0.9rem;
      }

      .level-popup {
        padding: 20px 15px;
      }

      .results-screen h1 {
        font-size: 1.8rem;
      }

      .results-screen .score > div:first-child {
        font-size: 2.5rem;
      }

      .results-screen .rewards {
        font-size: 1rem;
        gap: 10px;
      }

      .game-over-screen h1 {
        font-size: 1.8rem;
      }

      .broken-heart {
        font-size: 3.5rem;
      }

      .streak-badge {
        top: 155px;
        right: 5px;
        padding: 6px 10px;
        font-size: 0.7rem;
      }

      /* Hide streak on map for small mobile */
      #map:not([style*="display: none"]) ~ .streak-badge {
        display: none !important;
      }
    }

    /* Landscape mode adjustments */
    @media (max-height: 600px) and (orientation: landscape) {
      .main-logo {
        padding: 15px 10px 5px;
      }

      .main-logo h1 {
        font-size: 2rem;
      }

      .main-logo h1::before,
      .main-logo h1::after {
        display: none;
      }

      .main-logo .subtitle {
        font-size: 0.8rem;
      }

      .decorative-line {
        margin: 10px auto;
        height: 2px;
      }

      .level-map {
        padding: 5px 0 40px;
      }

      .row {
        height: 80px;
      }

      .level {
        width: 60px;
        height: 60px;
        font-size: 1rem;
        margin: 20px 0;
      }

      .level-popup {
        padding: 20px;
      }

      .streak-badge {
        top: 15px;
        right: 8px;
        padding: 6px 12px;
        font-size: 0.75rem;
      }

      /* Hide streak on map in landscape too */
      #map:not([style*="display: none"]) ~ .streak-badge {
        display: none !important;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .level {
        /* Larger touch targets */
        min-width: 70px;
        min-height: 70px;
      }

      .quiz-option {
        /* Larger touch targets for quiz options */
        min-height: 50px;
        padding: 16px 18px;
      }

      .level-popup button,
      .results-screen button,
      .game-over-screen button {
        /* Larger touch targets for buttons */
        min-height: 50px;
        padding: 15px 30px;
      }
    }

    /* Glowing effect for active elements */
    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
      }
      50% {
        box-shadow: 0 0 40px rgba(102, 126, 234, 0.8);
      }
    }

    /* Floating animation for unlocked levels */
    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-8px);
      }
    }

    .level:not(.locked):not(.completed) {
      animation: float 3s ease-in-out infinite;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <button id="back-btn" style="background: transparent; border: none; cursor: pointer; font-size: 1.5rem; color: #666;">‚Üê</button>
    <div style="display: flex; align-items: center; gap: 15px;">
      <span class="energy" id="energy-container" style="display: none;">
        <span id="hearts-display"></span>
      </span>
      <span class="coins">üí∞ <span id="coin-count">120</span></span>
    </div>
  </div>

  <div class="streak-badge" id="streak-badge" title="Racha diaria: Completa al menos 1 nivel cada d√≠a consecutivo">
    üî• Racha: <span id="streak-count">0</span> <span style="font-size: 0.8em; opacity: 0.9;">d√≠as</span>
  </div>

  <div class="popup-overlay" id="popup-overlay"></div>

  <div class="streak-notification" id="streak-notification"></div>

  <div class="main-logo">
    <h1>SabaDingo</h1>
    <div class="subtitle">Aprende finanzas jugando</div>
    <div class="decorative-line"></div>
  </div>

  <div id="map" class="level-map">
    <div class="connector"></div>
    <!-- SVG overlay para conectores curvos -->
    <svg id="map-svg" class="map-svg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMin meet" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:-3"></svg>

    <div class="row">
      <div class="level completed left" data-level="1">1</div>
    </div>
    <div class="row">
      <div class="level completed right" data-level="2">2</div>
    </div>
    <div class="row">
      <div class="level left" data-level="3">3</div>
    </div>
    <div class="row">
      <div class="level locked right" data-level="4">4</div>
    </div>
    <div class="row">
      <div class="level locked left" data-level="5">5</div>
    </div>
    <div class="row">
      <div class="level locked right" data-level="6">6</div>
    </div>
    <div class="row">
      <div class="level locked left" data-level="7">7</div>
    </div>
    <div class="row">
      <div class="level locked right" data-level="8">8</div>
    </div>
    <div class="row">
      <div class="level locked left" data-level="9">9</div>
    </div>
    <div class="row">
      <div class="level locked right" data-level="10">10</div>
    </div>
  </div>

  <div id="popup" class="level-popup">
    <span class="close-popup" id="close-popup">‚úñ</span>
    <h2 id="popup-title">Nivel 3: Seguridad Financiera</h2>
    <button id="start-level">Comenzar</button>
  </div>

  <div id="demo" class="level-demo">
    <div id="quiz-container" style="width: 90%; max-width: 550px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 35px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.25); border: 3px solid rgba(255, 255, 255, 0.8);">
      <div class="progress-bar" style="margin-bottom: 25px;">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <h2 id="quiz-title" style="color: #764ba2; margin-bottom: 15px; font-weight: 700; font-size: 1.3rem;">Pregunta 1 de 3</h2>
      <p id="quiz-question" style="font-size: 1.25rem; margin: 25px 0; color: #1f2937; font-weight: 600; line-height: 1.6;">¬øQu√© es un presupuesto?</p>
      <div id="quiz-options" style="display: flex; flex-direction: column; gap: 14px; margin-top: 30px;">
        <!-- Opciones se generar√°n din√°micamente -->
      </div>
      <div id="quiz-feedback" class="quiz-feedback"></div>
    </div>
  </div>

  <div id="game-over" class="game-over-screen">
    <h1>üíî Sin Energ√≠a üíî</h1>
    <div class="broken-heart">üíî</div>
    <p>Te has quedado sin corazones en este nivel.</p>
    <p style="font-size: 1.1rem; opacity: 0.9;">¬°No te rindas! Int√©ntalo de nuevo cuando est√©s listo.</p>
    <button id="retry-btn">Volver al Mapa</button>
  </div>

  <div id="results" class="results-screen">
    <h1 id="results-title">üéâ ¬°Nivel Completado! üéâ</h1>
    <div class="score">
      <div id="results-score">3/3</div>
      <div style="font-size: 1.3rem; margin-top: 15px; font-weight: 600; opacity: 0.95;">Respuestas correctas</div>
    </div>
    <div class="rewards">
      <div>üí∞ +<span id="coins-earned">30</span></div>
      <div>‚≠ê +<span id="xp-earned">100</span> XP</div>
    </div>
    <div id="results-message" style="font-size: 1.15rem; margin: 25px 0; max-width: 450px; line-height: 1.6; opacity: 0.95;"></div>
    <button id="continue-btn">Continuar</button>
  </div>

  <!-- Fidelity Plan / Rewards Modal -->
  <div id="rewards-modal" class="rewards-modal">
    <div class="rewards-modal-content">
      <span class="close-rewards" id="close-rewards">‚úñ</span>
      <h1 class="rewards-title">üíé Plan de Fidelidad üíé</h1>
      <p class="rewards-subtitle">Canjea tus monedas por premios incre√≠bles</p>

      <div class="rewards-balance">
        <span class="balance-label">Tu saldo:</span>
        <span class="balance-amount">üí∞ <span id="modal-coin-count">120</span> monedas</span>
      </div>

      <div class="rewards-tabs">
        <button class="rewards-tab active" data-tab="cashback">üéÅ Cashback</button>
        <button class="rewards-tab" data-tab="lottery">üé∞ Sorteos</button>
      </div>

      <div class="rewards-container">
        <!-- Cashback Section -->
        <div id="cashback-section" class="rewards-section active">
          <div class="rewards-grid" id="cashback-grid">
            <!-- Cashback items will be generated here -->
          </div>
        </div>

        <!-- Lottery Section -->
        <div id="lottery-section" class="rewards-section">
          <div class="rewards-grid" id="lottery-grid">
            <!-- Lottery items will be generated here -->
          </div>
        </div>
      </div>

      <div class="my-prizes-section">
        <h3>üèÜ Mis Premios</h3>
        <div id="my-prizes-list" class="my-prizes-list">
          <p class="no-prizes">A√∫n no has canjeado ning√∫n premio</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === DATOS DE NIVELES Y QUIZZES ===
    const levelsData = {
      1: {
        title: 'Conceptos B√°sicos',
        questions: [
          {
            question: '¬øQu√© es un presupuesto?',
            options: ['Un plan para gastar dinero', 'Una tarjeta de cr√©dito', 'Un tipo de moneda', 'Una aplicaci√≥n bancaria'],
            correct: 0
          },
          {
            question: '¬øQu√© significa "ahorrar"?',
            options: ['Gastar todo el dinero', 'Guardar dinero para el futuro', 'Pedir dinero prestado', 'Invertir en acciones'],
            correct: 1
          },
          {
            question: '¬øCu√°l es la diferencia entre ingreso y gasto?',
            options: ['No hay diferencia', 'Ingreso es lo que ganas, gasto es lo que pagas', 'Son lo mismo', 'Gasto es lo que ganas'],
            correct: 1
          }
        ]
      },
      2: {
        title: 'Gesti√≥n de Gastos',
        questions: [
          {
            question: '¬øQu√© es un gasto fijo?',
            options: ['Un gasto que cambia cada mes', 'Un gasto que se repite regularmente', 'Un gasto opcional', 'Un gasto de lujo'],
            correct: 1
          },
          {
            question: '¬øCu√°l es un ejemplo de gasto variable?',
            options: ['Alquiler', 'Ocio y entretenimiento', 'Seguro del coche', 'Suscripci√≥n mensual'],
            correct: 1
          },
          {
            question: '¬øPor qu√© es importante categorizar los gastos?',
            options: ['Para pagar m√°s impuestos', 'Para entender d√≥nde va tu dinero', 'No es importante', 'Solo para empresas'],
            correct: 1
          }
        ]
      },
      3: {
        title: 'Ahorro Inteligente',
        questions: [
          {
            question: '¬øQu√© porcentaje de tus ingresos deber√≠as intentar ahorrar?',
            options: ['0%', 'Al menos 10-20%', '100%', '5%'],
            correct: 1
          },
          {
            question: '¬øQu√© es un fondo de emergencia?',
            options: ['Dinero para comprar lujos', 'Dinero guardado para imprevistos', 'Una cuenta bancaria premium', 'Un pr√©stamo especial'],
            correct: 1
          },
          {
            question: '¬øCu√°l es una buena pr√°ctica de ahorro?',
            options: ['Ahorrar solo si sobra dinero', 'Ahorrar primero, gastar despu√©s', 'Nunca ahorrar', 'Ahorrar solo en diciembre'],
            correct: 1
          }
        ]
      },
      4: {
        title: 'Tarjetas y Pagos',
        questions: [
          {
            question: '¬øQu√© es una tarjeta de d√©bito?',
            options: ['Una tarjeta que usa dinero prestado', 'Una tarjeta que usa tu propio dinero', 'Una tarjeta regalo', 'Una tarjeta de fidelizaci√≥n'],
            correct: 1
          },
          {
            question: '¬øQu√© diferencia hay entre d√©bito y cr√©dito?',
            options: ['Ninguna', 'D√©bito usa tu dinero, cr√©dito es dinero prestado', 'Son lo mismo', 'Cr√©dito es m√°s barato'],
            correct: 1
          },
          {
            question: '¬øQu√© es el PIN de una tarjeta?',
            options: ['El n√∫mero de la tarjeta', 'Un c√≥digo secreto de seguridad', 'El nombre del banco', 'La fecha de caducidad'],
            correct: 1
          }
        ]
      },
      5: {
        title: 'Seguridad Financiera',
        questions: [
          {
            question: '¬øDeber√≠as compartir tu PIN con amigos?',
            options: ['S√≠, siempre', 'No, nunca', 'Solo con familia', 'Solo por WhatsApp'],
            correct: 1
          },
          {
            question: '¬øQu√© es el phishing?',
            options: ['Un deporte acu√°tico', 'Un fraude para robar datos personales', 'Un tipo de inversi√≥n', 'Una aplicaci√≥n bancaria'],
            correct: 1
          },
          {
            question: '¬øEs seguro guardar contrase√±as en el m√≥vil?',
            options: ['S√≠, siempre', 'Solo en aplicaciones seguras con cifrado', 'En notas sin protecci√≥n', 'En fotos'],
            correct: 1
          }
        ]
      },
      6: {
        title: 'Inversi√≥n B√°sica',
        questions: [
          {
            question: '¬øQu√© es invertir?',
            options: ['Guardar dinero en casa', 'Poner dinero en algo que puede crecer', 'Gastar dinero', 'Pedir prestado'],
            correct: 1
          },
          {
            question: '¬øQu√© es una acci√≥n?',
            options: ['Un tipo de moneda', 'Una parte de propiedad de una empresa', 'Un pr√©stamo', 'Una tarjeta de cr√©dito'],
            correct: 1
          },
          {
            question: '¬øLas inversiones siempre ganan dinero?',
            options: ['S√≠, siempre', 'No, pueden tener riesgos', 'Solo en verano', 'Depende del banco'],
            correct: 1
          }
        ]
      },
      7: {
        title: 'Pr√©stamos y Cr√©ditos',
        questions: [
          {
            question: '¬øQu√© es un pr√©stamo?',
            options: ['Dinero que te regalan', 'Dinero que pides prestado y debes devolver', 'Un tipo de ahorro', 'Una inversi√≥n'],
            correct: 1
          },
          {
            question: '¬øQu√© es el inter√©s de un pr√©stamo?',
            options: ['El dinero extra que pagas por pedir prestado', 'El dinero que te regalan', 'El dinero que ahorras', 'Una tarjeta'],
            correct: 0
          },
          {
            question: '¬øEs bueno pedir muchos pr√©stamos?',
            options: ['S√≠, cuantos m√°s mejor', 'No, solo lo necesario y que puedas pagar', 'Da igual', 'Solo en enero'],
            correct: 1
          }
        ]
      },
      8: {
        title: 'Planificaci√≥n Financiera',
        questions: [
          {
            question: '¬øQu√© es un objetivo financiero?',
            options: ['Una meta de ahorro o inversi√≥n', 'Un tipo de cuenta', 'Una tarjeta especial', 'Un pr√©stamo'],
            correct: 0
          },
          {
            question: '¬øPor qu√© es importante tener objetivos financieros?',
            options: ['No es importante', 'Te ayuda a ahorrar con prop√≥sito', 'Solo para adultos', 'Para pagar impuestos'],
            correct: 1
          },
          {
            question: '¬øQu√© es el horizonte temporal de un objetivo?',
            options: ['El color del objetivo', 'El tiempo que tardar√°s en lograrlo', 'El banco donde ahorras', 'El dinero necesario'],
            correct: 1
          }
        ]
      },
      9: {
        title: 'Impuestos y Responsabilidad',
        questions: [
          {
            question: '¬øQu√© son los impuestos?',
            options: ['Dinero que pagas al estado', 'Dinero que ahorras', 'Dinero que inviertes', 'Un tipo de tarjeta'],
            correct: 0
          },
          {
            question: '¬øPara qu√© sirven los impuestos?',
            options: ['Para nada', 'Para financiar servicios p√∫blicos (sanidad, educaci√≥n, etc.)', 'Para enriquecer a los pol√≠ticos', 'Para el banco'],
            correct: 1
          },
          {
            question: '¬øA qu√© edad empiezas a pagar impuestos?',
            options: ['A los 10 a√±os', 'Cuando empiezas a trabajar y ganar dinero', 'A los 65 a√±os', 'Nunca'],
            correct: 1
          }
        ]
      },
      10: {
        title: 'Econom√≠a Global',
        questions: [
          {
            question: '¬øQu√© es la inflaci√≥n?',
            options: ['Cuando los precios bajan', 'Cuando los precios suben con el tiempo', 'Un tipo de moneda', 'Una aplicaci√≥n'],
            correct: 1
          },
          {
            question: '¬øQu√© es el tipo de cambio?',
            options: ['El precio de una moneda en relaci√≥n a otra', 'Un tipo de ahorro', 'Una tarjeta', 'Un pr√©stamo'],
            correct: 0
          },
          {
            question: '¬øPor qu√© es importante entender la econom√≠a global?',
            options: ['No es importante', 'Porque afecta tu poder de compra y decisiones financieras', 'Solo para economistas', 'Para viajar'],
            correct: 1
          }
        ]
      }
    };

    // === DATOS DE PREMIOS ===
    const rewardsData = {
      cashback: [
        {
          id: 'cashback_netflix',
          icon: 'üé¨',
          name: '10% Cashback Netflix',
          description: 'Recupera 10% en tu pr√≥xima suscripci√≥n',
          price: 50,
          category: 'cashback'
        },
        {
          id: 'cashback_spotify',
          icon: 'üéµ',
          name: '15% Cashback Spotify',
          description: 'Descuento en tu m√∫sica favorita',
          price: 40,
          category: 'cashback'
        },
        {
          id: 'cashback_amazon',
          icon: 'üì¶',
          name: '5% Cashback Amazon',
          description: 'Ahorra en tus compras online',
          price: 80,
          category: 'cashback'
        },
        {
          id: 'cashback_zara',
          icon: 'üëï',
          name: '20% Cashback Zara',
          description: 'Descuento especial en moda',
          price: 100,
          category: 'cashback'
        },
        {
          id: 'cashback_mcdonalds',
          icon: 'üçî',
          name: '25% Cashback McDonald\'s',
          description: 'Tu comida favorita con descuento',
          price: 60,
          category: 'cashback'
        },
        {
          id: 'cashback_starbucks',
          icon: '‚òï',
          name: '30% Cashback Starbucks',
          description: 'Caf√© premium con descuento',
          price: 70,
          category: 'cashback'
        }
      ],
      lottery: [
        {
          id: 'lottery_iphone',
          icon: 'üì±',
          name: 'Sorteo iPhone 15 Pro',
          description: '1 participaci√≥n en sorteo mensual',
          price: 150,
          category: 'lottery'
        },
        {
          id: 'lottery_apple_watch',
          icon: '‚åö',
          name: 'Sorteo Apple Watch',
          description: '1 participaci√≥n en sorteo semanal',
          price: 100,
          category: 'lottery'
        },
        {
          id: 'lottery_airpods',
          icon: 'üéß',
          name: 'Sorteo AirPods Pro',
          description: '2 participaciones en sorteo diario',
          price: 80,
          category: 'lottery'
        },
        {
          id: 'lottery_playstation',
          icon: 'üéÆ',
          name: 'Sorteo PlayStation 5',
          description: '1 participaci√≥n en sorteo trimestral',
          price: 200,
          category: 'lottery'
        },
        {
          id: 'lottery_ipad',
          icon: 'üì≤',
          name: 'Sorteo iPad Air',
          description: '1 participaci√≥n en sorteo mensual',
          price: 120,
          category: 'lottery'
        },
        {
          id: 'lottery_switch',
          icon: 'üïπÔ∏è',
          name: 'Sorteo Nintendo Switch',
          description: '1 participaci√≥n en sorteo quincenal',
          price: 90,
          category: 'lottery'
        }
      ]
    };

    // DIBUJAR CURVAS SVG ENTRE NODOS
    function drawCurves() {
      const svg = document.getElementById('map-svg');
      const map = document.getElementById('map');

      // usar dimensiones completas del contenedor (incluye scroll) para el SVG
      const width = Math.max(map.scrollWidth, map.clientWidth);
      const height = Math.max(map.scrollHeight, map.clientHeight);
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      svg.style.width = width + 'px';
      svg.style.height = height + 'px';
      svg.innerHTML = '';

      const levels = Array.from(document.querySelectorAll('.row .level'));

      // helper: posici√≥n relativa de un elemento dentro del contenedor 'map'
      function getRelativePos(el, container) {
        let x = 0, y = 0;
        let node = el;
        while (node && node !== container) {
          x += node.offsetLeft || 0;
          y += node.offsetTop || 0;
          node = node.offsetParent;
        }
        // a√±adir la mitad del tama√±o para obtener el centro
        x += (el.offsetWidth || 0) / 2;
        y += (el.offsetHeight || 0) / 2;
        return { x, y };
      }

      for (let i = 0; i < levels.length - 1; i++) {
        const aPos = getRelativePos(levels[i], map);
        const bPos = getRelativePos(levels[i+1], map);

        const ax = aPos.x;
        const ay = aPos.y;
        const bx = bPos.x;
        const by = bPos.y;

        // control points m√°s amplios para curvas pronunciadas tipo mapa
        const dx = bx - ax;
        const cyOffset = Math.max(80, Math.abs(ay - by) * 0.6);
        const cx1 = ax + dx * 0.35;
        const cy1 = ay + cyOffset;
        const cx2 = ax + dx * 0.65;
        const cy2 = by - cyOffset;

        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', `M ${ax} ${ay} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${bx} ${by}`);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','rgba(255, 255, 255, 0.3)');
        path.setAttribute('stroke-width','10');
        path.setAttribute('stroke-linecap','round');
        path.setAttribute('stroke-linejoin','round');
        path.setAttribute('opacity','0.8');
        svg.appendChild(path);
      }
    }

    // Redibujar en carga y resize
    window.addEventListener('load', drawCurves);
    window.addEventListener('resize', () => { setTimeout(drawCurves, 120); });
    window.addEventListener('scroll', () => { /* redibujar si el contenedor se mueve */ setTimeout(drawCurves, 60); });

    // === GAME STATE ===
    let gameState = {
      coins: 120,
      xp: 0,
      currentLevel: null,
      currentQuestionIndex: 0,
      correctAnswers: 0,
      currentLevelEnergy: 2, // Energ√≠a para el nivel actual (corazones)
      streak: 0,
      lastCompletionDate: null, // Fecha de la √∫ltima vez que complet√≥ un nivel (YYYY-MM-DD)
      completedToday: false, // Si ya complet√≥ al menos 1 nivel hoy
      completedLevels: [],
      purchasedRewards: [] // IDs de premios canjeados
    };

    // === UTILIDADES DE FECHA ===
    function getTodayDateString() {
      const today = new Date();
      return today.toISOString().split('T')[0]; // YYYY-MM-DD
    }

    function getYesterdayDateString() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return yesterday.toISOString().split('T')[0];
    }

    function daysDifference(date1String, date2String) {
      const d1 = new Date(date1String);
      const d2 = new Date(date2String);
      const diffTime = Math.abs(d2 - d1);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    // Cargar estado guardado
    function loadGameState() {
      const saved = localStorage.getItem('sabadingo_progress');
      if (saved) {
        const savedState = JSON.parse(saved);
        gameState = { ...gameState, ...savedState };

        // Validar racha diaria
        validateDailyStreak();
        updateUI();
      }
    }

    // Validar si la racha sigue activa
    function validateDailyStreak() {
      const today = getTodayDateString();
      const yesterday = getYesterdayDateString();

      if (!gameState.lastCompletionDate) {
        // Primera vez, no hay racha
        gameState.streak = 0;
        gameState.completedToday = false;
        return;
      }

      // Comprobar si ya complet√≥ hoy
      if (gameState.lastCompletionDate === today) {
        gameState.completedToday = true;
        // La racha sigue igual
        return;
      }

      // Comprobar si complet√≥ ayer (racha contin√∫a)
      if (gameState.lastCompletionDate === yesterday) {
        gameState.completedToday = false;
        // La racha est√° intacta, pero a√∫n no ha completado hoy
        return;
      }

      // Si han pasado m√°s de 1 d√≠a, se pierde la racha
      const daysSinceLastCompletion = daysDifference(gameState.lastCompletionDate, today);
      if (daysSinceLastCompletion > 1) {
        gameState.streak = 0;
        gameState.completedToday = false;
      }
    }

    // Guardar estado
    function saveGameState() {
      localStorage.setItem('sabadingo_progress', JSON.stringify(gameState));
    }

    // Actualizar UI
    function updateUI() {
      document.getElementById('coin-count').innerText = gameState.coins;
      document.getElementById('streak-count').innerText = gameState.streak;

      // Actualizar niveles completados y bloqueados
      const levels = document.querySelectorAll('.level');
      levels.forEach(level => {
        const lvl = parseInt(level.dataset.level);
        level.classList.remove('completed', 'locked');

        if (gameState.completedLevels.includes(lvl)) {
          level.classList.add('completed');
        } else if (lvl > 1 && !gameState.completedLevels.includes(lvl - 1)) {
          level.classList.add('locked');
        }
      });

      // Mostrar badge de racha si hay racha
      if (gameState.streak > 0) {
        document.getElementById('streak-badge').classList.add('show');
      } else {
        document.getElementById('streak-badge').classList.remove('show');
      }
    }

    // Actualizar corazones en la UI
    function updateHeartsDisplay() {
      const heartsDisplay = document.getElementById('hearts-display');
      heartsDisplay.innerHTML = '';

      for (let i = 0; i < 2; i++) {
        const heart = document.createElement('span');
        heart.className = 'heart';
        heart.innerHTML = i < gameState.currentLevelEnergy ? '‚ù§Ô∏è' : 'üñ§';
        if (i >= gameState.currentLevelEnergy) {
          heart.classList.add('lost');
        }
        heartsDisplay.appendChild(heart);
      }
    }

    // Perder un coraz√≥n con animaci√≥n
    function loseHeart() {
      if (gameState.currentLevelEnergy > 0) {
        const hearts = document.querySelectorAll('.heart');
        const heartToLose = hearts[gameState.currentLevelEnergy - 1];

        if (heartToLose) {
          heartToLose.classList.add('losing');
          setTimeout(() => {
            gameState.currentLevelEnergy--;
            updateHeartsDisplay();
          }, 300);
        }
      }
    }

    // === ELEMENTOS DEL DOM ===
    const levels = document.querySelectorAll('.level');
    const popup = document.getElementById('popup');
    const popupOverlay = document.getElementById('popup-overlay');
    const closePopup = document.getElementById('close-popup');
    const startBtn = document.getElementById('start-level');
    const map = document.getElementById('map');
    const demo = document.getElementById('demo');
    const gameOverScreen = document.getElementById('game-over');
    const resultsScreen = document.getElementById('results');
    const progressFill = document.getElementById('progress-fill');
    const quizTitle = document.getElementById('quiz-title');
    const quizQuestion = document.getElementById('quiz-question');
    const quizOptions = document.getElementById('quiz-options');
    const quizFeedback = document.getElementById('quiz-feedback');
    const energyContainer = document.getElementById('energy-container');

    // === MOSTRAR BURBUJA DE NIVEL ===
    levels.forEach(level => {
      level.addEventListener('click', () => {
        if (!level.classList.contains('locked')) {
          const lvl = parseInt(level.dataset.level);
          const levelData = levelsData[lvl];
          popup.style.display = 'block';
          popupOverlay.style.display = 'block';
          setTimeout(() => {
            popup.classList.add('show');
            popupOverlay.classList.add('show');
          }, 10);
          document.getElementById('popup-title').innerText = `Nivel ${lvl}: ${levelData.title}`;
          gameState.currentLevel = lvl;
        }
      });
    });

    // Cerrar burbuja
    function closePopupModal() {
      popup.classList.remove('show');
      popupOverlay.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
        popupOverlay.style.display = 'none';
      }, 300);
    }

    closePopup.addEventListener('click', closePopupModal);
    popupOverlay.addEventListener('click', closePopupModal);

    // === COMENZAR NIVEL ===
    startBtn.addEventListener('click', () => {
      // Reiniciar energ√≠a del nivel
      gameState.currentLevelEnergy = 2;
      gameState.currentQuestionIndex = 0;
      gameState.correctAnswers = 0;

      closePopupModal();
      map.style.display = 'none';
      demo.style.display = 'flex';
      resultsScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';

      // Mostrar contenedor de corazones
      energyContainer.style.display = 'flex';
      updateHeartsDisplay();

      startQuiz();
    });

    // === SISTEMA DE QUIZ ===
    function startQuiz() {
      displayQuestion();
    }

    function displayQuestion() {
      const levelData = levelsData[gameState.currentLevel];
      const questions = levelData.questions;
      const currentQ = questions[gameState.currentQuestionIndex];

      // Actualizar t√≠tulo y pregunta
      quizTitle.innerText = `Pregunta ${gameState.currentQuestionIndex + 1} de ${questions.length}`;
      quizQuestion.innerText = currentQ.question;

      // Actualizar barra de progreso
      const progress = ((gameState.currentQuestionIndex + 1) / questions.length) * 100;
      progressFill.style.width = progress + '%';

      // Limpiar opciones anteriores y feedback
      quizOptions.innerHTML = '';
      quizFeedback.style.display = 'none';
      quizFeedback.className = 'quiz-feedback';

      // Crear opciones
      currentQ.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'quiz-option';
        button.innerText = option;
        button.onclick = () => selectAnswer(index);
        quizOptions.appendChild(button);
      });
    }

    function selectAnswer(selectedIndex) {
      const levelData = levelsData[gameState.currentLevel];
      const currentQ = levelData.questions[gameState.currentQuestionIndex];
      const isCorrect = selectedIndex === currentQ.correct;

      // Deshabilitar todas las opciones
      const options = quizOptions.querySelectorAll('.quiz-option');
      options.forEach((opt, idx) => {
        opt.disabled = true;
        if (idx === currentQ.correct) {
          opt.classList.add('correct');
        } else if (idx === selectedIndex && !isCorrect) {
          opt.classList.add('incorrect');
        }
      });

      // Mostrar feedback
      quizFeedback.style.display = 'block';
      if (isCorrect) {
        gameState.correctAnswers++;
        quizFeedback.className = 'quiz-feedback correct';
        quizFeedback.innerHTML = '‚úÖ ¬°Correcto! ' + getPositiveFeedback();
        quizFeedback.classList.add('celebrate');

        // Avanzar a siguiente pregunta despu√©s de 2 segundos
        setTimeout(() => {
          gameState.currentQuestionIndex++;
          if (gameState.currentQuestionIndex < levelData.questions.length) {
            displayQuestion();
          } else {
            completeLevel();
          }
        }, 2000);
      } else {
        quizFeedback.className = 'quiz-feedback incorrect';
        quizFeedback.innerHTML = '‚ùå Incorrecto. ' + getEncouragingFeedback();
        quizFeedback.classList.add('shake');

        // Perder un coraz√≥n
        loseHeart();

        // Comprobar si se qued√≥ sin energ√≠a
        setTimeout(() => {
          if (gameState.currentLevelEnergy === 0) {
            // Game Over
            showGameOver();
          } else {
            // Continuar con siguiente pregunta
            gameState.currentQuestionIndex++;
            if (gameState.currentQuestionIndex < levelData.questions.length) {
              displayQuestion();
            } else {
              completeLevel();
            }
          }
        }, 2000);
      }
    }

    function getPositiveFeedback() {
      const messages = [
        '¬°Excelente trabajo!',
        '¬°Muy bien!',
        '¬°Genial!',
        '¬°Incre√≠ble!',
        '¬°Eres un experto!',
        '¬°Sigue as√≠!'
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    }

    function getEncouragingFeedback() {
      const messages = [
        'Pero no te preocupes, ¬°sigue intent√°ndolo!',
        '¬°La pr√≥xima vez lo conseguir√°s!',
        '¬°Aprendes con cada intento!',
        '¬°No te rindas!',
        '¬°Cada error es una oportunidad de aprender!'
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    }

    // === ACTUALIZAR RACHA DIARIA ===
    function updateDailyStreak() {
      const today = getTodayDateString();
      const yesterday = getYesterdayDateString();

      // Si ya complet√≥ hoy, no hacer nada
      if (gameState.completedToday && gameState.lastCompletionDate === today) {
        return { streakIncreased: false, isNewDay: false };
      }

      let streakIncreased = false;
      let isNewDay = false;

      // Primera vez completando un nivel
      if (!gameState.lastCompletionDate) {
        gameState.streak = 1;
        gameState.lastCompletionDate = today;
        gameState.completedToday = true;
        streakIncreased = true;
        isNewDay = true;
      }
      // Complet√≥ ayer, racha contin√∫a
      else if (gameState.lastCompletionDate === yesterday) {
        gameState.streak++;
        gameState.lastCompletionDate = today;
        gameState.completedToday = true;
        streakIncreased = true;
        isNewDay = true;
      }
      // Completando hoy por primera vez
      else if (gameState.lastCompletionDate !== today) {
        // Si pasaron m√°s de 1 d√≠a, reiniciar racha
        const daysSince = daysDifference(gameState.lastCompletionDate, today);
        if (daysSince > 1) {
          gameState.streak = 1;
        }
        gameState.lastCompletionDate = today;
        gameState.completedToday = true;
        streakIncreased = true;
        isNewDay = true;
      }

      return { streakIncreased, isNewDay };
    }

    // === COMPLETAR NIVEL ===
    function completeLevel() {
      const levelData = levelsData[gameState.currentLevel];
      const totalQuestions = levelData.questions.length;
      const scorePercentage = (gameState.correctAnswers / totalQuestions) * 100;

      // Calcular recompensas (basado en respuestas correctas y corazones restantes)
      let coinsEarned = 0;
      let xpEarned = 0;
      const heartsBonus = gameState.currentLevelEnergy * 5; // Bonus por corazones restantes

      if (scorePercentage === 100) {
        coinsEarned = 30 + heartsBonus;
        xpEarned = 100;
      } else if (scorePercentage >= 66) {
        coinsEarned = 20 + Math.floor(heartsBonus / 2);
        xpEarned = 75;
      } else if (scorePercentage >= 33) {
        coinsEarned = 10 + Math.floor(heartsBonus / 3);
        xpEarned = 50;
      } else {
        coinsEarned = 5;
        xpEarned = 25;
      }

      // Aplicar recompensas
      gameState.coins += coinsEarned;
      gameState.xp += xpEarned;

      // Marcar nivel como completado
      if (!gameState.completedLevels.includes(gameState.currentLevel)) {
        gameState.completedLevels.push(gameState.currentLevel);
      }

      // Actualizar racha diaria
      const streakUpdate = updateDailyStreak();

      saveGameState();

      // Mostrar pantalla de resultados
      demo.style.display = 'none';
      resultsScreen.style.display = 'flex';

      document.getElementById('results-score').innerText = `${gameState.correctAnswers}/${totalQuestions}`;
      document.getElementById('coins-earned').innerText = coinsEarned;
      document.getElementById('xp-earned').innerText = xpEarned;

      // Mensaje personalizado
      let message = '';
      if (scorePercentage === 100) {
        message = 'üéâ ¬°Perfecto! Has dominado este nivel completamente.';
      } else if (scorePercentage >= 66) {
        message = 'üëè ¬°Muy bien! Has demostrado un gran conocimiento.';
      } else if (scorePercentage >= 33) {
        message = 'üëç ¬°Buen trabajo! Sigue practicando para mejorar.';
      } else {
        message = 'üí™ ¬°Sigue intent√°ndolo! Cada intento te hace m√°s fuerte.';
      }

      // Mensaje de corazones restantes
      if (gameState.currentLevelEnergy > 0) {
        message += ` Te quedaron ${gameState.currentLevelEnergy} ‚ù§Ô∏è (+${heartsBonus} monedas bonus).`;
      }

      // A√±adir mensaje de racha si aument√≥ hoy
      if (streakUpdate.streakIncreased && streakUpdate.isNewDay) {
        message += `\n\nüî• ¬°Racha diaria aumentada a ${gameState.streak} ${gameState.streak === 1 ? 'd√≠a' : 'd√≠as'}!`;

        // Mostrar notificaci√≥n de racha
        showStreakNotification(gameState.streak);
      }

      document.getElementById('results-message').innerText = message;

      // Confetti para puntuaci√≥n perfecta
      if (scorePercentage === 100) {
        createConfetti();
      }

      // Mostrar badge de racha actualizada
      updateUI();
    }

    // === MOSTRAR NOTIFICACI√ìN DE RACHA ===
    function showStreakNotification(streakDays) {
      const notification = document.getElementById('streak-notification');
      const badge = document.getElementById('streak-badge');

      let notificationText = '';
      if (streakDays === 1) {
        notificationText = 'üî• ¬°Racha iniciada! üî•<br><span style="font-size: 1rem;">Vuelve ma√±ana para continuar</span>';
      } else if (streakDays === 7) {
        notificationText = `üî•üî•üî• ¬°${streakDays} d√≠as seguidos! üî•üî•üî•<br><span style="font-size: 1rem;">¬°Incre√≠ble dedicaci√≥n!</span>`;
      } else if (streakDays === 30) {
        notificationText = `üèÜüî• ¬°${streakDays} d√≠as! üî•üèÜ<br><span style="font-size: 1rem;">¬°Eres imparable!</span>`;
      } else if (streakDays % 10 === 0) {
        notificationText = `üî• ¬°${streakDays} d√≠as! üî•<br><span style="font-size: 1rem;">¬°Sigue as√≠!</span>`;
      } else {
        notificationText = `üî• ¬°Racha: ${streakDays} ${streakDays === 1 ? 'd√≠a' : 'd√≠as'}! üî•<br><span style="font-size: 1rem;">Sigue adelante</span>`;
      }

      notification.innerHTML = notificationText;
      notification.classList.add('show');

      // Animar badge
      badge.classList.add('celebrate-streak');

      setTimeout(() => {
        notification.classList.remove('show');
        badge.classList.remove('celebrate-streak');
      }, 2500);
    }

    // === CONFETTI EFFECT ===
    function createConfetti() {
      const colors = ['#42d9ff', '#0033a0', '#00C853', '#FFB300', '#FF3B30'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.style.position = 'fixed';
          confetti.style.width = Math.random() * 10 + 5 + 'px';
          confetti.style.height = confetti.style.width;
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.top = '-10px';
          confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
          confetti.style.opacity = '1';
          confetti.style.zIndex = '9999';
          document.body.appendChild(confetti);

          const duration = Math.random() * 2000 + 2000;
          const rotation = Math.random() * 360;
          confetti.animate([
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(100vh) rotate(${rotation}deg)`, opacity: 0 }
          ], {
            duration: duration,
            easing: 'ease-in'
          });

          setTimeout(() => confetti.remove(), duration);
        }, i * 30);
      }
    }

    // === MOSTRAR GAME OVER ===
    function showGameOver() {
      demo.style.display = 'none';
      gameOverScreen.style.display = 'flex';
      energyContainer.style.display = 'none';
    }

    // === CONTINUAR DESPU√âS DE RESULTADOS ===
    document.getElementById('continue-btn').addEventListener('click', () => {
      resultsScreen.style.display = 'none';
      map.style.display = 'flex';
      energyContainer.style.display = 'none';
      updateUI();
      saveGameState();
    });

    // === REINTENTAR DESPU√âS DE GAME OVER ===
    document.getElementById('retry-btn').addEventListener('click', () => {
      gameOverScreen.style.display = 'none';
      map.style.display = 'flex';
      energyContainer.style.display = 'none';
      updateUI();
    });

    // === BOT√ìN DE RETORNO ===
    document.getElementById('back-btn').addEventListener('click', () => {
      // Guardar estado antes de salir
      saveGameState();
      window.location.href = '../../web/index.html';
    });


    // === REWARDS MODAL FUNCTIONALITY ===
    const rewardsModal = document.getElementById('rewards-modal');
    const closeRewardsBtn = document.getElementById('close-rewards');
    const coinsElement = document.querySelector('.coins');
    const modalCoinCount = document.getElementById('modal-coin-count');
    const cashbackGrid = document.getElementById('cashback-grid');
    const lotteryGrid = document.getElementById('lottery-grid');
    const myPrizesList = document.getElementById('my-prizes-list');
    const rewardsTabs = document.querySelectorAll('.rewards-tab');

    // Abrir modal de recompensas al hacer click en las monedas
    coinsElement.addEventListener('click', () => {
      openRewardsModal();
    });

    // Cerrar modal
    closeRewardsBtn.addEventListener('click', () => {
      closeRewardsModal();
    });

    // Cerrar modal al hacer click fuera
    rewardsModal.addEventListener('click', (e) => {
      if (e.target === rewardsModal) {
        closeRewardsModal();
      }
    });

    // Cambiar entre tabs
    rewardsTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;

        // Actualizar tabs activos
        rewardsTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Actualizar secciones activas
        document.querySelectorAll('.rewards-section').forEach(section => {
          section.classList.remove('active');
        });
        document.getElementById(`${targetTab}-section`).classList.add('active');
      });
    });

    function openRewardsModal() {
      rewardsModal.style.display = 'block';
      setTimeout(() => {
        rewardsModal.classList.add('show');
      }, 10);

      // Actualizar balance de monedas en el modal
      modalCoinCount.innerText = gameState.coins;

      // Renderizar premios
      renderRewards();
      renderMyPrizes();
    }

    function closeRewardsModal() {
      rewardsModal.classList.remove('show');
      setTimeout(() => {
        rewardsModal.style.display = 'none';
      }, 300);
    }

    function renderRewards() {
      // Renderizar cashback
      cashbackGrid.innerHTML = '';
      rewardsData.cashback.forEach(reward => {
        const card = createRewardCard(reward);
        cashbackGrid.appendChild(card);
      });

      // Renderizar lottery
      lotteryGrid.innerHTML = '';
      rewardsData.lottery.forEach(reward => {
        const card = createRewardCard(reward);
        lotteryGrid.appendChild(card);
      });
    }

    function createRewardCard(reward) {
      const card = document.createElement('div');
      card.className = 'reward-card';

      // Verificar si ya fue comprado
      const isPurchased = gameState.purchasedRewards.includes(reward.id);

      // Verificar si tiene suficientes monedas
      const hasEnoughCoins = gameState.coins >= reward.price;

      if (isPurchased) {
        card.classList.add('purchased');
      } else if (!hasEnoughCoins) {
        card.classList.add('insufficient');
      }

      card.innerHTML = `
        <div class="reward-icon">${reward.icon}</div>
        <div class="reward-name">${reward.name}</div>
        <div class="reward-description">${reward.description}</div>
        <div class="reward-price">üí∞ ${reward.price}</div>
      `;

      // Solo permitir compra si tiene suficientes monedas y no ha sido comprado
      if (!isPurchased && hasEnoughCoins) {
        card.addEventListener('click', () => {
          purchaseReward(reward);
        });
      }

      return card;
    }

    function purchaseReward(reward) {
      // Verificar nuevamente que tenga suficientes monedas
      if (gameState.coins < reward.price) {
        alert('No tienes suficientes monedas para este premio.');
        return;
      }

      // Verificar que no haya sido comprado ya
      if (gameState.purchasedRewards.includes(reward.id)) {
        alert('Ya has canjeado este premio.');
        return;
      }

      // Confirmar compra
      const confirmed = confirm(`¬øSeguro que quieres canjear "${reward.name}" por ${reward.price} monedas?`);

      if (confirmed) {
        // Deducir monedas
        gameState.coins -= reward.price;

        // A√±adir a premios comprados
        gameState.purchasedRewards.push(reward.id);

        // Guardar estado
        saveGameState();

        // Actualizar UI
        updateUI();
        modalCoinCount.innerText = gameState.coins;

        // Renderizar de nuevo
        renderRewards();
        renderMyPrizes();

        // Mostrar confetti
        createConfetti();

        // Mensaje de √©xito
        setTimeout(() => {
          alert(`¬°Felicidades! Has canjeado: ${reward.name}\n\nMonedas restantes: ${gameState.coins}`);
        }, 500);
      }
    }

    function renderMyPrizes() {
      myPrizesList.innerHTML = '';

      if (gameState.purchasedRewards.length === 0) {
        myPrizesList.innerHTML = '<p class="no-prizes">A√∫n no has canjeado ning√∫n premio</p>';
        return;
      }

      // Obtener todos los premios comprados
      const allRewards = [...rewardsData.cashback, ...rewardsData.lottery];
      const purchasedRewardsList = gameState.purchasedRewards.map(id => {
        return allRewards.find(r => r.id === id);
      }).filter(r => r !== undefined);

      // Renderizar badges
      purchasedRewardsList.forEach(reward => {
        const badge = document.createElement('div');
        badge.className = 'prize-badge';
        badge.innerHTML = `${reward.icon} ${reward.name}`;
        myPrizesList.appendChild(badge);
      });
    }

    // === FUNCIONES DE DEPURACI√ìN (solo para desarrollo) ===
    // Descomentar para probar diferentes escenarios de racha
    window.debugStreak = {
      // Simular que complet√≥ ayer
      setYesterday: function() {
        gameState.lastCompletionDate = getYesterdayDateString();
        gameState.streak = 5;
        gameState.completedToday = false;
        saveGameState();
        console.log('‚úÖ Simulado: √öltima completaci√≥n AYER. Racha actual: 5 d√≠as');
        console.log('Al completar un nivel hoy, la racha aumentar√° a 6');
        loadGameState();
      },
      // Simular que ya complet√≥ hoy
      setToday: function() {
        gameState.lastCompletionDate = getTodayDateString();
        gameState.streak = 3;
        gameState.completedToday = true;
        saveGameState();
        console.log('‚úÖ Simulado: Ya complet√≥ HOY. Racha actual: 3 d√≠as');
        console.log('Al completar otro nivel hoy, la racha NO aumentar√°');
        loadGameState();
      },
      // Simular que no complet√≥ en 3 d√≠as (racha perdida)
      setGap: function() {
        const date = new Date();
        date.setDate(date.getDate() - 3);
        gameState.lastCompletionDate = date.toISOString().split('T')[0];
        gameState.streak = 10;
        gameState.completedToday = false;
        saveGameState();
        console.log('‚úÖ Simulado: √öltima completaci√≥n hace 3 D√çAS. Racha era: 10 d√≠as');
        console.log('Al completar un nivel hoy, la racha se reiniciar√° a 1');
        loadGameState();
      },
      // Resetear todo
      reset: function() {
        localStorage.removeItem('sabadingo_progress');
        console.log('‚úÖ Progreso eliminado. Recarga la p√°gina.');
      },
      // Mostrar estado actual
      status: function() {
        console.log('üìä Estado actual:');
        console.log('  - Racha:', gameState.streak, 'd√≠as');
        console.log('  - √öltima completaci√≥n:', gameState.lastCompletionDate || 'Nunca');
        console.log('  - Complet√≥ hoy:', gameState.completedToday ? 'S√≠' : 'No');
        console.log('  - Fecha de hoy:', getTodayDateString());
      }
    };

    console.log('üîß Funciones de depuraci√≥n disponibles:');
    console.log('  window.debugStreak.setYesterday() - Simular completaci√≥n ayer');
    console.log('  window.debugStreak.setToday() - Simular completaci√≥n hoy');
    console.log('  window.debugStreak.setGap() - Simular 3 d√≠as sin completar');
    console.log('  window.debugStreak.reset() - Resetear progreso');
    console.log('  window.debugStreak.status() - Ver estado actual');

    // === INICIALIZACI√ìN ===
    loadGameState();
    drawCurves();
  </script>
</body>
</html>
